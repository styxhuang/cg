async function j(url,opt){try{const r=await fetch(url,opt||{});const t=await r.text();try{return{ok:r.ok,status:r.status,data:JSON.parse(t)}}catch(e){return{ok:r.ok,status:r.status,data:{raw:t}}}}catch(e){return{ok:false,status:0,data:{error:String(e)}}}}
function setStepDone(id){document.querySelectorAll('[data-step]').forEach(s=>{if(s.getAttribute('data-step')===id)s.classList.add('done')})}
function enable(ids){ids.forEach(id=>{const el=document.getElementById(id);if(el)el.disabled=false})}
async function loadEnv(){const r=await j('/env');const el=document.getElementById('env');if(el)el.textContent=r.ok?('Python '+(r.data.python||'')):'环境不可用'}
let rid=null
const form=document.getElementById('uploadForm')
const uploadLog=document.getElementById('uploadLog')
const ridHint=document.getElementById('ridHint')
const workflowLog=document.getElementById('workflowLog')
const btnMap=document.getElementById('btnMap')
const btnRdf=document.getElementById('btnRdf')
const btnInvConfig=document.getElementById('btnInvConfig')
const btnInvRun=document.getElementById('btnInvRun')
const btnTable=document.getElementById('btnTable')
const btnListFiles=document.getElementById('btnListFiles')
const selComputed=document.getElementById('selComputed')
const targetPath=document.getElementById('targetPath')
const btnCompare=document.getElementById('btnCompare')
const btnShowCG=document.getElementById('btnShowCG')
const btnOverlay=document.getElementById('btnOverlay')
const convertLog=document.getElementById('convertLog')
const viewer=document.getElementById('viewer3d')
if(form){form.addEventListener('submit',async(e)=>{e.preventDefault();const fd=new FormData(e.target);const r=await j('/upload',{method:'POST',body:fd});uploadLog.textContent=JSON.stringify(r.data,null,2);rid=r.data.rid||null;ridHint.textContent=rid?('RID: '+rid):'';if(rid){setStepDone('upload');enable(['btnMap','btnListFiles'])}})}
if(btnMap){btnMap.addEventListener('click',async()=>{if(!rid)return;const fd=new FormData();fd.append('rid',rid);const r=await j('/votca/map',{method:'POST',body:fd});workflowLog.textContent=JSON.stringify(r.data,null,2);if(r.data.ok){setStepDone('map');enable(['btnShowCG','btnRdf'])}})}
if(btnRdf){btnRdf.addEventListener('click',async()=>{if(!rid)return;const fd=new FormData();fd.append('rid',rid);const r=await j('/rdf/run',{method:'POST',body:fd});workflowLog.textContent=JSON.stringify(r.data,null,2);if(r.data.ok){setStepDone('rdf');enable(['btnInvConfig'])}})}
if(btnInvConfig){btnInvConfig.addEventListener('click',async()=>{if(!rid)return;const fd=new FormData();fd.append('rid',rid);const r=await j('/inverse/config',{method:'POST',body:fd});workflowLog.textContent=JSON.stringify(r.data,null,2);if(r.data.ok){enable(['btnInvRun'])}})}
if(btnInvRun){btnInvRun.addEventListener('click',async()=>{if(!rid)return;const fd=new FormData();fd.append('rid',rid);const r=await j('/inverse/run',{method:'POST',body:fd});workflowLog.textContent=JSON.stringify(r.data,null,2);if(r.data.ok){setStepDone('inverse');enable(['btnTable','btnCompare'])}})}
if(btnTable){btnTable.addEventListener('click',async()=>{if(!rid)return;const fd=new FormData();fd.append('rid',rid);const r=await j('/ff/table',{method:'POST',body:fd});workflowLog.textContent=JSON.stringify(r.data,null,2);if(r.data.ok){setStepDone('table')}})}
if(btnListFiles){btnListFiles.addEventListener('click',async()=>{if(!rid)return;const r=await j('/ff/list?rid='+encodeURIComponent(rid));selComputed.innerHTML='';(r.data.files||[]).forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;selComputed.appendChild(o)});enable(['btnCompare'])})}
if(btnCompare){btnCompare.addEventListener('click',async()=>{const comp=selComputed.value;const tgt=targetPath.value;const fd1=new FormData();fd1.append('path',comp);const fd2=new FormData();fd2.append('path',tgt);const r1=await j('/api/ff/parse',{method:'POST',body:fd1});const r2=await j('/api/ff/parse',{method:'POST',body:fd2});const ds=[];if(r1.data.x&&r1.data.y)ds.push({x:r1.data.x,y:r1.data.y,type:'scatter',name:'Computed'});if(r2.data.x&&r2.data.y)ds.push({x:r2.data.x,y:r2.data.y,type:'scatter',name:'Target'});if(ds.length)Plotly.newPlot('plot',ds,{margin:{t:20},xaxis:{title:'r'},yaxis:{title:'g(r)'}});setStepDone('compare')})}
function parsePDB(text){const atoms=[];const lines=text.split(/\r?\n/);for(const line of lines){if(line.startsWith('ATOM')||line.startsWith('HETATM')){const x=parseFloat(line.slice(30,38));const y=parseFloat(line.slice(38,46));const z=parseFloat(line.slice(46,54));const elem=(line.slice(76,78).trim()||line.slice(12,16).trim()).replace(/[0-9]/g,'');atoms.push({x,y,z,elem})}}return atoms}
function deg2rad(d){return d*Math.PI/180}
function rotateAndProject(atoms,rx,ry,scale){const sx=Math.sin(deg2rad(rx)),cx=Math.cos(deg2rad(rx));const sy=Math.sin(deg2rad(ry)),cy=Math.cos(deg2rad(ry));return atoms.map(a=>{let y1=a.y*cx-a.z*sx;let z1=a.y*sx+a.z*cx;let x2=a.x*cy+z1*sy;let z2=-a.x*sy+z1*cy;return{x:x2*scale,y:y1*scale,z:z2,elem:a.elem}})}
function drawCanvas(atoms){const canvas=document.getElementById('pdbCanvas');if(!canvas)return;const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);const rx=parseFloat(document.getElementById('rotX').value||'0');const ry=parseFloat(document.getElementById('rotY').value||'0');const scl=(parseFloat(document.getElementById('scale').value||'100')/100);const proj=rotateAndProject(atoms,rx,ry,scl);const minx=Math.min(...proj.map(p=>p.x)),maxx=Math.max(...proj.map(p=>p.x));const miny=Math.min(...proj.map(p=>p.y)),maxy=Math.max(...proj.map(p=>p.y));const cx=(minx+maxx)/2,cy=(miny+maxy)/2;for(const p of proj){const x=(p.x-cx)+canvas.width/2;const y=(p.y-cy)+canvas.height/2;const r=6;const color=p.elem==='C'?'#9fb0c8':p.elem==='H'?'#ccd6e3':'#aab8cc';ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();ctx.strokeStyle='#5b6f8f';ctx.stroke()}}
async function loadCGToViewer(){if(!rid)return;const r=await j('/file?path='+encodeURIComponent('backend/workspace/'+rid+'/cg_conf.gro'));const d=r.data;if(!d.ok){convertLog.textContent=JSON.stringify(d);return}const conv=new FormData();conv.append('path','backend/workspace/'+rid+'/cg_conf.gro');const r2=await j('/convert/pdb',{method:'POST',body:conv});const p=r2.data;if(!p.ok){convertLog.textContent=JSON.stringify(p);return}const r3=await j('/file?path='+encodeURIComponent(p.out));const cont=r3.data;if(!cont.ok){convertLog.textContent=JSON.stringify(cont);return}viewer.innerHTML='';if(window.$3Dmol){const v=$3Dmol.createViewer('viewer3d',{backgroundColor:'white'});v.addModel(cont.content,'pdb');v.setStyle({}, {sphere:{radius:0.6}});v.zoomTo();v.render();convertLog.textContent='已加载 CG' } else {const canvas=document.createElement('canvas');canvas.width=800;canvas.height=360;canvas.style.width='100%';canvas.style.height='360px';canvas.style.border='1px solid #203055';canvas.style.borderRadius='12px';viewer.appendChild(canvas);window.pdbAtoms=parsePDB(cont.content);canvas.id='pdbCanvas';drawCanvas(window.pdbAtoms);convertLog.textContent='已加载 CG（Canvas）'}}
if(btnShowCG){btnShowCG.addEventListener('click',loadCGToViewer)}
if(btnOverlay){btnOverlay.addEventListener('click',async()=>{if(!rid)return;const convA=new FormData();convA.append('path','backend/workspace/'+rid+'/eth.gro');await j('/convert/pdb',{method:'POST',body:convA});const convB=new FormData();convB.append('path','backend/workspace/'+rid+'/cg_conf.gro');await j('/convert/pdb',{method:'POST',body:convB});const rA=await j('/file?path='+encodeURIComponent('backend/workspace/'+rid+'/eth.pdb'));const rB=await j('/file?path='+encodeURIComponent('backend/workspace/'+rid+'/cg_conf.pdb'));viewer.innerHTML='';if(window.$3Dmol&&rA.data.ok&&rB.data.ok){const v=$3Dmol.createViewer('viewer3d',{backgroundColor:'white'});v.addModel(rA.data.content,'pdb');v.setStyle({model:0},{stick:{radius:0.25}});v.addModel(rB.data.content,'pdb');v.setStyle({model:1},{sphere:{radius:0.8,color:'red'}});v.zoomTo();v.render();convertLog.textContent='已叠加'} })}
const btnRedraw=document.getElementById('btnRedraw')
if(btnRedraw){btnRedraw.addEventListener('click',()=>{if(window.pdbAtoms)drawCanvas(window.pdbAtoms)})}
loadEnv()
