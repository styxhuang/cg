<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VOTCA 可视化粗粒化</title>
  <script src="/static/lib/3Dmol-min.js"></script>
  <script src="/static/lib/plotly-2.27.0.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:8px;padding:16px;flex:1;min-width:300px}
    button{padding:8px 12px}
    input{margin:4px 0}
    .log{white-space:pre-wrap;background:#f7f7f7;border:1px dashed #ccc;padding:8px;border-radius:6px}
    #viewer3d{position:relative}
  </style>
</head>
<body>
  <h1>VOTCA 可视化粗粒化</h1>
  <div class="row">
    <div class="card">
      <h3>上传输入文件</h3>
      <form id="uploadForm">
        <div>
          <label>拓扑文件</label>
          <input type="file" name="top" required>
        </div>
        <div>
          <label>轨迹文件</label>
          <input type="file" name="trj" required>
        </div>
        <div>
          <label>映射文件 mapping.xml</label>
          <input type="file" name="mapping" required>
        </div>
        <button type="submit">上传</button>
      </form>
      <div id="uploadResult" class="log"></div>
    </div>
    <div class="card">
      <h3>VOTCA 可用性</h3>
      <button id="btnCheck">检查命令</button>
      <div id="checkResult" class="log"></div>
    </div>
  </div>
  <div class="row">
    <div class="card">
      <h3>乙烯示例一键运行</h3>
      <button id="btnRunEthylene">运行示例（grompp→mdrun→csg_map）</button>
      <div id="workflowLog" class="log"></div>
      <button id="btnShowCG">查看 CG 结果</button>
      <div id="cgContent" class="log"></div>
      <button id="btnGenFF" style="margin-top:8px">生成粗粒化力场（初始 PMF）</button>
      <div id="ffLog" class="log"></div>
    </div>
  </div>
  <div class="row">
    <div class="card">
      <h3>3D 结构查看（内置渲染）</h3>
      <div id="viewer3d" style="width:100%;height:400px;border:1px solid #ddd;border-radius:6px"></div>
      <div style="margin-top:8px">
        <button id="btnConvertPDB">将 CG gro 转为 PDB</button>
        <button id="btnLoadPDB">加载 PDB 到视图</button>
        <button id="btnLoadOverlay" style="margin-left:8px">叠加原子与CG</button>
        <div id="convertLog" class="log"></div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="card">
      <h3>RDF/PMF 占位图</h3>
      <div style="margin-bottom:8px">
        <button id="btnRDF">生成并绘制 RDF（AB）</button>
        <button id="btnTables" style="margin-left:8px">导出 GROMACS 表格</button>
        <button id="btnCgTop" style="margin-left:8px">导出 CG 拓扑</button>
      </div>
      <div id="plot" style="height:300px"></div>
    </div>
  </div>
  <script>
    const form = document.getElementById('uploadForm')
    const uploadResult = document.getElementById('uploadResult')
    const checkResult = document.getElementById('checkResult')
    let rid = null
    async function safeFetchJson(url, options){
      try{
        const res = await fetch(url, options||{})
        const text = await res.text()
        try { return { ok: res.ok, status: res.status, data: JSON.parse(text) } } catch(e){ return { ok: res.ok, status: res.status, data: { raw: text } } }
      } catch (err){
        return { ok: false, status: 0, data: { error: String(err) } }
      }
    }
    form.addEventListener('submit', async (e)=>{
      e.preventDefault()
      const fd = new FormData(form)
      const res = await fetch('/api/upload', { method:'POST', body: fd })
      const data = await res.json()
      uploadResult.textContent = JSON.stringify(data, null, 2)
      rid = data.rid
    })
    document.getElementById('btnCheck').addEventListener('click', async ()=>{
      const r = await safeFetchJson('/api/votca/check')
      checkResult.textContent = JSON.stringify(r.data, null, 2)
    })
    const workflowLog = document.getElementById('workflowLog')
    const cgContent = document.getElementById('cgContent')
    const ffLog = document.getElementById('ffLog')
    document.getElementById('btnRunEthylene').addEventListener('click', async ()=>{
      workflowLog.textContent = '运行中...'
      const r = await safeFetchJson('/api/workflow/ethylene', { method:'POST' })
      workflowLog.textContent = JSON.stringify(r.data, null, 2)
    })
    document.getElementById('btnShowCG').addEventListener('click', async ()=>{
      cgContent.textContent = '读取中...'
      const r = await safeFetchJson('/api/file?path=example/ethylene/cg_conf.gro')
      const d = r.data
      cgContent.textContent = d.ok ? d.content : JSON.stringify(d)
    })
    document.getElementById('btnGenFF').addEventListener('click', async ()=>{
      ffLog.textContent = '生成中...'
      const r = await safeFetchJson('/api/workflow/ff', { method:'POST' })
      ffLog.textContent = JSON.stringify(r.data, null, 2)
    })
    let pdbAtoms = []
    function parsePDB(text){
      const atoms = []
      const lines = text.split(/\r?\n/)
      for(const line of lines){
        if(line.startsWith('ATOM') || line.startsWith('HETATM')){
          const x = parseFloat(line.slice(30,38))
          const y = parseFloat(line.slice(38,46))
          const z = parseFloat(line.slice(46,54))
          const elem = (line.slice(76,78).trim() || line.slice(12,16).trim()).replace(/[0-9]/g,'')
          atoms.push({ x, y, z, elem })
        }
      }
      return atoms
    }
    function deg2rad(d){ return d*Math.PI/180 }
    function rotateAndProject(atoms, rx, ry, scale){
      const sx = Math.sin(deg2rad(rx)), cx = Math.cos(deg2rad(rx))
      const sy = Math.sin(deg2rad(ry)), cy = Math.cos(deg2rad(ry))
      return atoms.map(a=>{
        let y1 = a.y*cx - a.z*sx
        let z1 = a.y*sx + a.z*cx
        let x2 = a.x*cy + z1*sy
        let z2 = -a.x*sy + z1*cy
        return { x: x2*scale, y: y1*scale, z: z2, elem: a.elem }
      })
    }
    function drawCanvas(atoms){
      const canvas = document.getElementById('pdbCanvas')
      const ctx = canvas.getContext('2d')
      ctx.clearRect(0,0,canvas.width,canvas.height)
      const rx = parseFloat(document.getElementById('rotX').value)
      const ry = parseFloat(document.getElementById('rotY').value)
      const scl = parseFloat(document.getElementById('scale').value)/100
      const proj = rotateAndProject(atoms, rx, ry, scl)
      const minx = Math.min(...proj.map(p=>p.x)), maxx = Math.max(...proj.map(p=>p.x))
      const miny = Math.min(...proj.map(p=>p.y)), maxy = Math.max(...proj.map(p=>p.y))
      const cx = (minx+maxx)/2, cy=(miny+maxy)/2
      for(const p of proj){
        const x = (p.x - cx) + canvas.width/2
        const y = (p.y - cy) + canvas.height/2
        const r = 6
        const color = p.elem==='C'? '#555' : p.elem==='H'? '#ccc' : '#888'
        ctx.beginPath()
        ctx.arc(x,y,r,0,Math.PI*2)
        ctx.fillStyle = color
        ctx.fill()
        ctx.strokeStyle = '#333'
        ctx.stroke()
      }
    }
    const convertLog = document.getElementById('convertLog')
    document.getElementById('btnConvertPDB').addEventListener('click', async ()=>{
      convertLog.textContent = '转换中...'
      const fd = new FormData()
      fd.append('path', 'example/ethylene/cg_conf.gro')
      const r = await safeFetchJson('/api/convert/pdb', { method:'POST', body: fd })
      convertLog.textContent = JSON.stringify(r.data, null, 2)
    })
    document.getElementById('btnLoadPDB').addEventListener('click', async ()=>{
      const r = await safeFetchJson('/api/file?path=example/ethylene/cg_conf.pdb')
      const data = r.data
      if(!data.ok){ convertLog.textContent = JSON.stringify(data); return }
      const container = document.getElementById('viewer3d')
      container.innerHTML = ''
      if(window.$3Dmol){
        const viewer = $3Dmol.createViewer('viewer3d', { backgroundColor: 'white' })
        viewer.addModel(data.content, 'pdb')
        viewer.setStyle({}, { sphere: { radius: 0.6 } })
        viewer.zoomTo()
        viewer.render()
        const model = viewer.getModel()
        if(!model || (model.getAtoms && model.getAtoms().length === 0)){
          convertLog.textContent = '3Dmol 解析失败，使用 Canvas 回退渲染'
        } else {
          convertLog.textContent = 'PDB 加载完成（3Dmol）'
          return
        }
      }
      const canvas = document.createElement('canvas')
      canvas.width = 800
      canvas.height = 400
      canvas.style.width = '100%'
      canvas.style.height = '400px'
      canvas.style.border = '1px solid #ddd'
      canvas.style.borderRadius = '6px'
      container.appendChild(canvas)
      pdbAtoms = parsePDB(data.content)
      canvas.id = 'pdbCanvas'
      drawCanvas(pdbAtoms)
      convertLog.textContent = 'PDB 加载完成（Canvas 回退）'
    })
    document.getElementById('btnLoadOverlay').addEventListener('click', async ()=>{
      convertLog.textContent = '准备叠加...'
      // 确保两个 PDB 存在
      await safeFetchJson('/api/convert/pdb', { method:'POST', body: (()=>{ const f=new FormData(); f.append('path','example/ethylene/eth.gro'); return f })() })
      await safeFetchJson('/api/convert/pdb', { method:'POST', body: (()=>{ const f=new FormData(); f.append('path','example/ethylene/cg_conf.gro'); return f })() })
      const rAtom = await safeFetchJson('/api/file?path=example/ethylene/eth.pdb')
      const rCG = await safeFetchJson('/api/file?path=example/ethylene/cg_conf.pdb')
      if(!rAtom.data.ok || !rCG.data.ok){ convertLog.textContent = '读取 PDB 失败'; return }
      const container = document.getElementById('viewer3d')
      container.innerHTML = ''
      if(window.$3Dmol){
        const viewer = $3Dmol.createViewer('viewer3d', { backgroundColor: 'white' })
        viewer.addModel(rAtom.data.content, 'pdb')
        viewer.setStyle({ model: 0 }, { stick: { radius: 0.25 } })
        viewer.addModel(rCG.data.content, 'pdb')
        viewer.setStyle({ model: 1 }, { sphere: { radius: 0.8, color: 'red' } })
        viewer.zoomTo()
        viewer.render()
        convertLog.textContent = '叠加完成（3Dmol）'
        return
      }
      // Canvas 回退叠加
      const canvas = document.createElement('canvas')
      canvas.width = 800
      canvas.height = 400
      canvas.style.width = '100%'
      canvas.style.height = '400px'
      canvas.style.border = '1px solid #ddd'
      canvas.style.borderRadius = '6px'
      container.appendChild(canvas)
      canvas.id = 'pdbCanvas'
      const atomsA = parsePDB(rAtom.data.content)
      const atomsB = parsePDB(rCG.data.content)
      // 绘制原子（灰） 与 CG（红）
      const rx = parseFloat(document.getElementById('rotX').value)
      const ry = parseFloat(document.getElementById('rotY').value)
      const scl = parseFloat(document.getElementById('scale').value)/100
      const projA = rotateAndProject(atomsA, rx, ry, scl)
      const projB = rotateAndProject(atomsB, rx, ry, scl)
      const ctx = canvas.getContext('2d')
      ctx.clearRect(0,0,canvas.width,canvas.height)
      const all = projA.concat(projB)
      const minx = Math.min(...all.map(p=>p.x)), maxx = Math.max(...all.map(p=>p.x))
      const miny = Math.min(...all.map(p=>p.y)), maxy = Math.max(...all.map(p=>p.y))
      const cx = (minx+maxx)/2, cy=(miny+maxy)/2
      for(const p of projA){
        const x = (p.x - cx) + canvas.width/2
        const y = (p.y - cy) + canvas.height/2
        ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fillStyle = '#666'; ctx.fill(); ctx.strokeStyle = '#333'; ctx.stroke()
      }
      for(const p of projB){
        const x = (p.x - cx) + canvas.width/2
        const y = (p.y - cy) + canvas.height/2
        ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fillStyle = '#e33'; ctx.fill(); ctx.strokeStyle = '#a00'; ctx.stroke()
      }
      convertLog.textContent = '叠加完成（Canvas 回退）'
    })
    const x = Array.from({length:50}, (_,i)=>i/10)
    const y = x.map(v=>Math.exp(-v))
    Plotly.newPlot('plot', [{x,y,type:'scatter'}], {margin:{t:20}, xaxis:{title:'r'}, yaxis:{title:'g(r) 或 PMF'}})
    document.getElementById('btnRDF').addEventListener('click', async ()=>{
      const r = await safeFetchJson('/api/rdf/run', { method:'POST' })
      const d = r.data
      if(!(d.x && d.y)) return
      Plotly.newPlot('plot', [{ x:d.x, y:d.y, type:'scatter', name:'AB g(r)' }], { margin:{t:20}, xaxis:{title:'r'}, yaxis:{title:'g(r)'} })
    })
    document.getElementById('btnTables').addEventListener('click', async ()=>{
      const r = await safeFetchJson('/api/gmx/table', { method:'POST' })
      document.getElementById('workflowLog').textContent = JSON.stringify(r.data, null, 2)
    })
    document.getElementById('btnCgTop').addEventListener('click', async ()=>{
      const r = await safeFetchJson('/api/cg/top', { method:'POST' })
      document.getElementById('workflowLog').textContent = JSON.stringify(r.data, null, 2)
    })
  </script>
</body>
</html>